@startuml
actor User
control SearchService
collections CacheRepository
database CityRepository
collections RankingRepository

== 기본 인기 도시 노출 ==
User -> SearchService : 초기 접속
SearchService -> RankingRepository : 올해 인기 해외도시 TOP20 조회
RankingRepository --> SearchService : ["도쿄","방콕","하노이", ...] (20개)
SearchService --> User : 인기 도시 리스트 반환

== 검색 요청 ==
User -> SearchService : 검색 요청("인도")

SearchService -> CacheRepository : GET "search:인도"
alt 캐시 히트
    CacheRepository --> SearchService : 결과 반환
else 캐시 미스
    CacheRepository --> SearchService : 없음
    SearchService -> CityRepository : pg_bigm 기반 유사도 검색
    CityRepository --> SearchService : 후보 리스트 ["인도","인도네시아","인도차이나"]

    SearchService -> LevenshteinDistance : 알고리즘 기반 유사도 정렬

    SearchService -> RankingRepository : 인기순 점수 조회
    SearchService -> SearchService : 유사도 정렬 결과에 인기순 가중치 적용

    SearchService -> SearchService : 상위 100개만 추출
    SearchService -> CacheRepository : SET "search:인도" 결과, ttl=10분
end

SearchService --> User : 최종 결과 리스트(100개 이내)

== 최종 선택 반영 ==
User -> SearchService : 최종 선택("인도네시아")
SearchService -> RankingRepository : ZINCRBY "search_ranking" "인도네시아" 1
@enduml
